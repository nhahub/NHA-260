<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Travely</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <link href="~/favicon.ico" rel="icon">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Josefin+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=flight_takeoff" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <link href="~/lib/aos/aos.css" rel="stylesheet">
    <link href="~/lib/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="~/lib/swiper/swiper-bundle.min.css" rel="stylesheet">
    <script type="importmap"></script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link href="~/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="~/Travely.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/login.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/footer.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/UsersTable.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/userprofile.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Register.css" asp-append-version="true" />
    <style>
        .site-logo {
            margin-left: 0px;
            transition: transform 0.3s ease-in-out;
        }

            .site-logo:hover {
                transform: scale(1.1);
            }

            .site-logo img {
                max-height: 60px;
                width: auto;
            }

        .profile-pic-nav {
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 1px solid #ddd; 
            margin-top: -5px;
        }

        .nav-profile-link {
            padding-top: 10px !important;
            padding-bottom: 10px !important;
        }
        .navmenu .dropdown .dropdown-menu {
            display: none;
            opacity: 0;
            visibility: hidden;
        }
        .navmenu .dropdown .dropdown-menu.show {
                display: block;
                opacity: 1;
                visibility: visible;
        }



        .notif-container {
            position: relative;
            display: inline-block;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
        }

        .material-symbols-outlined {
            font-size: 22px;
            cursor: pointer;
            color: #b5b5b5;
            justify-content: center;
            align-items: center;
            transition: color 0.3s;
        }

            .material-symbols-outlined:hover {
                color: white;
            }

        .notif-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: red;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
        }

        /* === Popup === */
        .notif-popup {
            position: absolute;
            top: 35px;
            right: 0;
            width: 250px;
            min-height: 150px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            overflow: hidden;
            z-index: 1000;
            display: none;
        }

            .notif-popup.visible {
                display: flex;
            }

        .notif-list {
            flex: 1; 
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .notif-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

            .notif-item.unread {
                background-color: #f5f8ff;
                font-weight: bold;
            }

            .notif-item:hover {
                background-color: #f0f4ff;
            }

        /* === Footer === */
        .notif-footer {
            background: #f8f9fa;
            padding: 0px;
            text-align: center;
            border-top: 1px solid #ddd;
            flex-shrink: 0; 
        }

        .notif-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

            .notif-link:hover {
                text-decoration: underline;
            }

        /* Utility */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    <header id="header" class="header sticky-top">

        <div class="topbar d-flex align-items-center dark-background">
            <div class="container d-flex justify-content-center justify-content-md-between">
                <div class="contact-info d-flex align-items-center">
                    <i class="bi bi-envelope d-flex align-items-center"><a href="#">info@Travely.com</a></i>
                    <i class="bi bi-phone d-flex align-items-center ms-4"><span>+2 33 123 4567 8901</span></i>
                </div>
                <div class="social-links d-none d-md-flex align-items-center">
                    <a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a>
                    <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>
        </div>


        <div class="branding d-flex align-items-center">

            <div class="container position-relative d-flex align-items-center justify-content-between">
                <a asp-controller="Home" asp-action="Index" class=" d-flex align-items-center site-logo" style="width:100px; height:auto;">
                    <img src="~/img/logo.webp" alt="logo">
                </a>

                <nav id="navmenu" class="navmenu">
                    <ul>
                        <li><a asp-area="" asp-controller="Home" asp-action="Index" class="@(Context.Request.Path.Value?.EndsWith("/Home") == true || Context.Request.Path.Value == "/" ? "active" : "")">Home</a></li>
                        <li><a asp-area="" asp-controller="Hotels" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/Hotels") == true ? "active" : "")">Hotels</a></li>
                        <li><a asp-area="" asp-controller="Rooms" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/Rooms") == true ? "active" : "")">Rooms</a></li>
                        <li><a asp-area="" asp-controller="About" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/About") == true ? "active" : "")">About</a></li>
                        <li><a asp-area="" asp-controller="ContactUS" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/ContactUS") == true ? "active" : "")">Contact Us</a></li>


                        @* @if (User.IsInRole("admin") || User.IsInRole("staff"))
                        {
                            <li>
                                <a asp-area="" asp-controller="Rooms" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/Rooms") == true ? "active" : "")">Manage Rooms</a>
                            </li>
                        } *@
                        @if (User.IsInRole("admin"))
                        {
                            <li>
                                <a asp-area="" asp-controller="TblUsers" asp-action="Index" class="@(Context.Request.Path.Value?.Contains("/TblUsers") == true ? "active" : "")">Manage Users</a>
                            </li>
                        }

                        @if (User.Identity != null && User.Identity.IsAuthenticated)
                        {

                            @*------------------------------*@
                            <div class="notif-container">
                                <span id="notifIcon" class="material-symbols-outlined">chat</span>
                                <span id="notifBadge" class="notif-badge" hidden>0</span>

                                <div id="notifPopup" class="notif-popup">
                                    <div id="notifList" class="notif-list">
                                    </div>
                                    <div class="notif-footer">
                                        <a asp-controller="Notifications" asp-action="Index" class="notif-link" 
                                        style="color:color-mix(in srgb, #2f5d50, white 5%); font-size:12px; text-align:center; justify-content:center;">Show all Notifications</a>
                                    </div>
                                </div>
                            </div>

                            @*------------------------------*@

                            var imagePathClaim = User.FindFirst("ImagePath");

                            var profilePicPath = (imagePathClaim != null && !string.IsNullOrEmpty(imagePathClaim.Value))
                            ? imagePathClaim.Value
                            : "/images/default-avatar.png"; 

                             <li class="nav-item dropdown">

                                <a class="nav-link dropdown-toggle nav-profile-link profile-dropdown-toggle @(Context.Request.Path.Value?.Contains("/Account/Profile") == true || Context.Request.Path.Value?.Contains("/Account/Edit") == true || Context.Request.Path.Value?.Contains("/Account/Wishlist") == true ? "active" : "")"
                                   href="#"
                                   id="navbarProfileLink"
                                   role="button"
                                   data-bs-toggle="dropdown"
                                   aria-expanded="false"
                                   title="My Profile">

                                    <img src="@profilePicPath" alt="Profile" class="profile-pic-nav" />
                                </a>

                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarProfileLink">

                                    <li>
                                        <a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Profile">
                                            <i class="fas fa-user-circle"></i> My Profile
                                        </a>
                                    </li>

                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post" id="logoutForm" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <a href="javascript:void(0);"
                                               onclick="event.preventDefault(); document.getElementById('logoutForm').submit();"
                                               class="dropdown-item">
                                                <i class="fas fa-sign-out-alt"></i> Logout
                                            </a>
                                        </form>
                                    </li>

                                </ul>
                            </li>
                         }
                        else
                        {
                            
                            <li><a asp-area="" asp-controller="Account" asp-action="Login" class="@(Context.Request.Path.Value?.Contains("/Account/Login") == true ? "active" : "")">Login <i class="fas fa-sign-in-alt me-1"></i></a></li>
                        }
                    </ul>
                    <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
                </nav>

            </div>

        </div>
    </header>


    <div class="container-fluid">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>
    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h2>Travely</h2>
                <p>123 Main Street</p>
                <p>Anytown, Anycountry</p>
                <p><strong>Phone:</strong> <span>+2 33 123 4567 8901</span></p>
                <p><strong>Email:</strong> <span>info@Travely.com</span></p>
            </div>
            <div class="footer-column">
                <h4>Our Services</h4>
                <a asp-area="" asp-controller="Home" asp-action="Index">Home</a>
                <a asp-area="" asp-controller="About" asp-action="Index">About</a>
                <a asp-area="" asp-controller="ContactUS" asp-action="Index">Contact Us</a>
                <a asp-area="" asp-controller="Home" asp-action="Terms">Terms of service</a>
                <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy policy</a>


            </div>
            <div class="footer-column" style="align-items: center;">
                <h4>Follow Us</h4>
                <a href=""><i class="bi bi-twitter-x"></i></a>
                <a href=""><i class="bi bi-facebook"></i></a>
                <a href=""><i class="bi bi-instagram"></i></a>
                <a href=""><i class="bi bi-linkedin"></i></a>
            </div>
        </div>
        <div class="footer-row">
            <p>© Copyright Travely. All Rights Reserved.</p>
            <p>Designed by Travely Team.</p>
        </div>
    </footer>

    @await RenderSectionAsync("Scripts", required: false)



    @* <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
*@ <div id="preloader"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/aos/aos.js"></script>
    <script src="~/lib/purecounter/purecounter_vanilla.js"></script>
    <script src="~/lib/glightbox/js/glightbox.min.js"></script>
    <script src="~/lib/swiper/swiper-bundle.min.js"></script>
    <script src="~/lib/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="~/lib/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="~/js/main.js"></script>

    <script>
        $(document).ready(function() {
            // Target the parent <li> of the profile dropdown
            var profileDropdownLi = $('#navbarProfileLink').closest('.nav-item.dropdown');
            var bsDropdownInstance = null;

            profileDropdownLi.on('mouseenter', function() {
                // Get the Bootstrap Dropdown instance
                var dropdownToggleEl = this.querySelector('[data-bs-toggle="dropdown"]');
                if (!bsDropdownInstance) {
                    bsDropdownInstance = bootstrap.Dropdown.getOrCreateInstance(dropdownToggleEl);
                }

                // Show the dropdown
                bsDropdownInstance.show();
            });

            profileDropdownLi.on('mouseleave', function() {
                // Hide the dropdown
                if (bsDropdownInstance) {
                    bsDropdownInstance.hide();
                }
            });

            // Prevent the default click behavior of the link (navigating to #)
            $('#navbarProfileLink').on('click', function(e) {
                e.preventDefault();
            });
        });




            document.addEventListener("DOMContentLoaded", function() {
            const notifIcon = document.getElementById("notifIcon");
            const notifPopup = document.getElementById("notifPopup");
            const notifList = document.getElementById("notifList");
            const notifBadge = document.getElementById("notifBadge");
            const notifContainer = document.querySelector(".notif-container");
            const userRole = document.querySelector('meta[name="user-role"]')?.content || "User";
            const userId = document.querySelector('meta[name="user-id"]')?.content || 0;

            // ✅ تحميل الإشعارات
            async function loadNotifications() {
                try {
                    const res = await fetch(`/Notifications/List?role=${userRole}&userId=${userId}`);
                    const html = await res.text();
                    notifList.innerHTML = html;

                    // حساب الغير مقروء
                    const unreadCount = notifList.querySelectorAll(".unread").length;
                    if (unreadCount > 0) {
                        notifBadge.textContent = unreadCount;
                        notifBadge.hidden = false;
                    } else {
                        notifBadge.hidden = true;
                    }

                    // عند الضغط على إشعار نعلّمه كمقروء
                    notifList.querySelectorAll(".notif-item").forEach(item => {
                        item.addEventListener("click", async () => {
                            const id = item.getAttribute("data-id");
                            await fetch(`/Notifications/MarkAsRead?id=${id}`, { method: "POST" });
                            item.classList.remove("unread");
                            loadNotifications(); // إعادة تحميل لتحديث الرقم
                        });
                    });

                } catch (err) {
                    notifList.innerHTML = "<div class='p-3 text-center text-muted'>Error loading notifications</div>";
                }
            }

            // ✅ فتح وغلق الـ popup
            notifIcon.addEventListener("click", () => {
                const isVisible = notifPopup.classList.toggle("visible");
                if (isVisible) loadNotifications();
            });

            // غلق الـ popup عند الضغط خارجها
            document.addEventListener("click", e => {
                if (!notifContainer.contains(e.target)) {
                    notifPopup.classList.remove("visible");
                }
            });

            // تحديث دوري كل 20 ثانية
            setInterval(loadNotifications, 20000);
        });
    </script>
</body>
</html>